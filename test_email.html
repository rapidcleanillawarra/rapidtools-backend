<!DOCTYPE html>
<html>
<head>
    <title>Test Order Notification HTML Output</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        #result { margin-top: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 4px; }
        iframe { width: 100%; height: 600px; border: 1px solid #ddd; }
        .input-group { margin: 10px 0; }
        label { display: inline-block; width: 120px; }
        input { padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
        select { padding: 5px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Test Maropost Order Notification HTML</h1>
    <p>Configure your test parameters and click the button to see the HTML output:</p>

    <div class="input-group">
        <label for="orderId">Order ID:</label>
        <input type="text" id="orderId" value="26-0011994" placeholder="e.g. 26-0011994">
    </div>

    <div class="input-group">
        <label>Display Mode:</label>
        <div style="display: inline-block; margin-left: 10px;">
            <label style="width: auto; margin-right: 15px;">
                <input type="radio" name="displayMode" value="email" checked> Email
            </label>
            <label style="width: auto; margin-right: 15px;">
                <input type="radio" name="displayMode" value="pdf"> PDF (Tax Invoice)
            </label>
            <label style="width: auto;">
                <input type="radio" name="displayMode" value="data"> Data (JSON)
            </label>
        </div>
    </div>

    <button onclick="testEndpoint()">Test HTML Output</button>

    <div id="result">
        <p>Click the button to see the HTML template...</p>
    </div>

    <script>
        async function testEndpoint() {
            const resultDiv = document.getElementById('result');
            const orderId = document.getElementById('orderId').value.trim();
            const displayMode = document.querySelector('input[name="displayMode"]:checked').value;

            try {
                resultDiv.innerHTML = '<p>Loading...</p>';

                const requestBody = {
                    CurrentTime: new Date().toISOString().replace('T', ' ').substring(0, 19),
                    EventID: "15846",
                    EventType: "Order",
                    OrderID: orderId || "26-0011994",
                    OrderStatus: "Dispatched",
                    Display: displayMode
                };

                const response = await fetch('http://localhost:8888/.netlify/functions/maropost_order_notification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    if (displayMode === 'data') {
                        // Handle JSON response for data mode
                        const jsonData = await response.json();
                        const displayType = 'JSON Data';
                        const fileName = 'order_data.json';
                        resultDiv.innerHTML = `
                            <h3>${displayType} Output (Order ID: ${orderId}):</h3>
                            <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto; max-height: 600px;">${JSON.stringify(jsonData, null, 2)}</pre>
                            <br><br>
                            <button onclick="downloadJSON(${JSON.stringify(jsonData)}, '${fileName}')">Download JSON</button>
                        `;
                    } else {
                        // Handle HTML response for email and pdf modes
                        const html = await response.text();
                        const displayType = displayMode === 'pdf' ? 'Tax Invoice PDF' : 'Email';
                        const fileName = displayMode === 'pdf' ? 'tax_invoice.html' : 'email_template.html';
                        resultDiv.innerHTML = `
                            <h3>HTML ${displayType} Output (Order ID: ${orderId}):</h3>
                            <iframe srcdoc="${html.replace(/"/g, '&quot;')}"></iframe>
                            <br><br>
                            <button onclick="downloadHTML('${html.replace(/"/g, '&quot;').replace(/\n/g, '\\n')}', '${fileName}')">Download HTML</button>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `<p>Error: ${response.status} ${response.statusText}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }

        function downloadHTML(html, filename = 'email_template.html') {
            const blob = new Blob([html.replace(/\\n/g, '\n').replace(/&quot;/g, '"')], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadJSON(jsonData, filename = 'order_data.json') {
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>